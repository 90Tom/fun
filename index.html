<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>90Tom fun!</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">

    <!-- UPDATED FIREBASE SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>

    <script>
      const firebaseConfig = {
        apiKey: "AIzaSyDNzjX6dmx2fGPhLW-ZIADhNigsfwMY3Ng",
        authDomain: "tom-fun.firebaseapp.com",
        projectId: "tom-fun",
        storageBucket: "tom-fun.appspot.com",
        messagingSenderId: "710857129785",
        appId: "1:710857129785:web:5f2cdebe736577ea0e72e8",
        measurementId: "G-6MHP8FHQ87"
      };

      let db, auth, storage;
      try {
        firebase.initializeApp(firebaseConfig);
        db = firebase.firestore();
        auth = firebase.auth();
        storage = firebase.storage();
      } catch (e) {
        console.error("Firebase initialization failed:", e);
        alert("CRITICAL ERROR: Could not connect to the kingdom's database. The leaderboards will not work.");
      }
    </script>

    <!-- CSS -->
    <style>
        :root {
            --body-bg-overlay: rgba(255, 255, 255, 0.7);
            --text-color: #333;
            --text-color-light: #666;
            --header-bg: rgba(255, 255, 255, 0.6);
            --card-bg: #ffffff;
            --card-h2-color: #0056b3;
            --footer-bg: rgba(255, 255, 255, 0.6);
            --modal-bg: #fefefe;
            --input-bg: #ffffff;
            --input-border: #ddd;
            --table-header-bg: #f2f2f2;
            --table-row-hover: #f9f9f9;
            --button-bg: rgba(250, 250, 250, 0.65);
            --button-border: rgba(0, 0, 0, 0.15);
            --button-hover-bg: rgba(255, 255, 255, 0.85);
            --button-hover-border: rgba(0, 0, 0, 0.25);
            --card-border: transparent;
            --xp-bar-bg: #e0e0e0;
            --xp-bar-fill: #ffd700;
        }

        body.dark-mode {
            --body-bg-overlay: rgba(18, 18, 18, 0.85);
            --text-color: #f0f0f0;
            --text-color-light: #a0a0a0;
            --header-bg: rgba(30, 30, 30, 0.75);
            --card-bg: #1e1e1e;
            --card-h2-color: #58a6ff;
            --footer-bg: rgba(30, 30, 30, 0.75);
            --modal-bg: #2c2c2c;
            --input-bg: #252525;
            --input-border: #444;
            --table-header-bg: #1f1f1f;
            --table-row-hover: #3a3a3a;
            --button-bg: rgba(45, 45, 45, 0.7);
            --button-border: rgba(255, 255, 255, 0.1);
            --button-hover-bg: rgba(60, 60, 60, 0.8);
            --button-hover-border: rgba(255, 255, 255, 0.2);
            --card-border: rgba(255, 255, 255, 0.1);
            --xp-bar-bg: #444;
            --xp-bar-fill: #f9a825;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Poppins', sans-serif; color: var(--text-color); line-height: 1.6; background-image: url('IndexImages/backgroundindex.png'); background-size: cover; background-position: center center; background-attachment: fixed; display: flex; flex-direction: column; min-height: 100vh; align-items: center; padding: 20px; position: relative; z-index: 1; transition: color 0.3s ease; }
        body::before { content: ''; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--body-bg-overlay); z-index: -1; transition: background-color 0.3s ease; }
        header { text-align: center; margin-bottom: 40px; margin-top: 20px; max-width: 800px; width: 100%; background-color: var(--header-bg); padding: 15px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05); position: relative; transition: background-color 0.3s ease; }
        header h1 { color: red; font-weight: 700; font-size: 3.5em; margin-bottom: 5px; position: relative; display: inline-block; padding-right: 60px; }
        .splash-text { position: absolute; bottom: 0px; right: 30px; font-size: 0.4em; font-weight: 600; color: #FFD700; padding: 2px 8px; border-radius: 4px; transform: rotate(-15deg); animation: splash-pulse 2s infinite alternate ease-in-out; white-space: nowrap; pointer-events: none; }
        @keyframes splash-pulse { from { transform: rotate(-22deg) scale(1.1); } to { transform: rotate(-16deg) scale(1.3); } }
        header p { color: var(--text-color); font-size: 1.1em; transition: color 0.3s ease; }
        .game-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 30px; max-width: 1000px; width: 100%; flex-grow: 1; justify-content: center; }
        .game-card { background-color: var(--card-bg); border-radius: 12px; color: var(--text-color); box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); transition: all 0.3s ease; display: flex; flex-direction: column; text-align: center; overflow: hidden; border: 1px solid var(--card-border); opacity: 0; transform: translateY(20px); aspect-ratio: 1 / 1; position: relative; }
        .game-card .game-link { display: flex; flex-direction: column; flex-grow: 1; text-decoration: none; color: inherit; height: 100%; }
        .game-card img { display: block; width: 100%; height: 65%; object-fit: cover; transition: transform 0.3s ease, filter 0.3s ease; }
        .game-card .content { padding: 15px; width: 100%; display: flex; flex-direction: column; justify-content: center; flex-grow: 1; overflow: hidden; }
        .game-card:hover { transform: translateY(-10px) scale(1.05); box-shadow: 0 12px 35px rgba(232, 62, 140, 0.25); border-color: #e83e8c; }
        .game-card:hover img { transform: scale(1.03); filter: brightness(1.05); }
        .game-card h2 { margin-bottom: 5px; color: var(--card-h2-color); font-size: 1.2em; font-weight: 600; }
        .game-card p { color: var(--text-color-light); font-size: 0.85em; line-height: 1.3; }
        .leaderboard-btn { position: absolute; top: 10px; right: 10px; background-color: rgba(240, 240, 240, 0.8); border: 1px solid rgba(221, 221, 221, 0.8); border-radius: 50%; width: 30px; height: 30px; cursor: pointer; font-size: 16px; line-height: 28px; text-align: center; transition: all 0.2s ease; z-index: 5; backdrop-filter: blur(2px); }
        .leaderboard-btn:hover { background-color: #e83e8c; color: white; transform: scale(1.1); }
        footer { text-align: center; margin-top: 50px; padding: 15px; font-size: 0.9em; width: 100%; max-width: 800px; background-color: var(--footer-bg); border-radius: 8px; transition: all 0.3s ease; }
        footer p { color: red; }
        #top-actions-container { position: fixed; top: 15px; right: 20px; z-index: 1001; display: flex; gap: 10px; align-items: center; }
        #chat-btn, #theme-switcher-btn, #language-switcher-btn, #login-btn { background-color: var(--button-bg); color: var(--text-color); border: 1px solid var(--button-border); padding: 7px 14px; border-radius: 6px; cursor: pointer; font-family: 'Poppins', sans-serif; font-weight: 500; font-size: 0.9em; transition: all 0.2s ease; outline: none; box-shadow: 0 1px 3px rgba(0,0,0,0.05); text-decoration: none; display: inline-flex; align-items: center; justify-content: center; }
        #login-btn { color: red; font-weight: 600; }
        #chat-btn:hover, #theme-switcher-btn:hover, #language-switcher-btn:hover, #login-btn:hover { background-color: var(--button-hover-bg); border-color: var(--button-hover-border); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        #login-btn:hover { color: #c00; }
        #language-switcher-btn .lang-current { font-weight: 600; }
        #language-switcher-btn .lang-separator { margin: 0 5px; opacity: 0.6; }
        #language-switcher-btn .lang-target { opacity: 0.7; }
        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); align-items: center; justify-content: center; }
        .modal-content { position: relative; background-color: var(--modal-bg); color: var(--text-color); padding: 40px; border-radius: 12px; box-shadow: 0 8px 30px rgba(0, 0, 0, 0.2); width: 90%; max-width: 500px; text-align: center; transition: all 0.3s ease; }
        .modal-content h1 { color: red; margin-bottom: 25px; font-weight: 600; }
        .input-group { margin-bottom: 20px; text-align: left; }
        .input-group label { display: block; margin-bottom: 8px; font-weight: 500; color: #d90429; }
        .input-group input { width: 100%; padding: 12px 15px; border-radius: 6px; border: 1px solid var(--input-border); font-family: 'Poppins', sans-serif; font-size: 1em; transition: border-color 0.3s ease, background-color 0.3s, color 0.3s; background-color: var(--input-bg); color: var(--text-color); }
        .input-group input:focus { outline: none; border-color: red; }
        .action-button { width: 100%; padding: 12px; border: none; background-color: red; color: white; font-size: 1.1em; font-weight: 600; border-radius: 6px; cursor: pointer; transition: background-color 0.3s ease; }
        .action-button:hover { background-color: #c00; }
        .error-message { color: red; margin-top: 15px; height: 20px; font-weight: 500; font-size: 0.9em; }
        .close-btn { color: #aaa; position: absolute; top: 10px; right: 20px; font-size: 28px; font-weight: bold; cursor: pointer; transition: color 0.3s ease;}
        .close-btn:hover, .close-btn:focus { color: var(--text-color); text-decoration: none; }
        .form-switch-text { margin-top: 20px; font-size: 0.9em; color: #d90429; }
        .form-switch-text a { color: red; font-weight: 600; cursor: pointer; text-decoration: none; }
        .form-switch-text a:hover { text-decoration: underline; }
        #register-view { display: none; }
        #leaderboard-table { width: 100%; margin-top: 20px; border-collapse: collapse; }
        #leaderboard-table th, #leaderboard-table td { padding: 10px; border-bottom: 1px solid var(--input-border); text-align: left; }
        #leaderboard-table th { background-color: var(--table-header-bg); }
        #leaderboard-table tr:hover { background-color: var(--table-row-hover); }
        .delete-score-btn { background: #ff5c5c; color: white; border: none; border-radius: 50%; width: 25px; height: 25px; cursor: pointer; line-height: 25px; font-size: 14px; }
        .delete-score-btn:hover { background: #ff1c1c; }
        
        /* NEW PROFILE & CHAT STYLES */
        #profile-modal .modal-content { max-width: 600px; }
        .profile-header { display: flex; align-items: center; margin-bottom: 30px; }
        #profile-pic-container { position: relative; }
        #profile-pic { width: 120px; height: 120px; border-radius: 50%; object-fit: cover; border: 4px solid red; }
        #upload-pic-label { position: absolute; bottom: 0; right: 0; background: #fff; border-radius: 50%; padding: 5px; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        #upload-pic-label:hover { background: #f0f0f0; }
        #upload-pic-icon { width: 24px; height: 24px; }
        #upload-pic-input { display: none; }
        .profile-info { margin-left: 25px; text-align: left; }
        #profile-name { font-size: 2em; font-weight: 700; color: red; margin: 0; }
        #profile-level { font-size: 1.2em; font-weight: 500; }
        .xp-bar-container { width: 100%; height: 20px; background-color: var(--xp-bar-bg); border-radius: 10px; overflow: hidden; margin-top: 8px; }
        #xp-bar-fill { width: 0%; height: 100%; background-color: var(--xp-bar-fill); border-radius: 10px; transition: width 0.5s ease; }
        #xp-text { font-size: 0.9em; text-align: right; }
        .achievements-section { margin-top: 20px; }
        .achievements-section h2 { border-bottom: 2px solid red; padding-bottom: 5px; margin-bottom: 15px; text-align: left;}
        #achievements-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); gap: 15px; }
        .achievement { text-align: center; }
        .achievement img { width: 60px; height: 60px; border-radius: 50%; background: #eee; }
        .achievement p { font-size: 0.8em; margin-top: 5px; }

        body.dark-mode #login-btn { color: #ff4d4d; }
        body.dark-mode #login-btn:hover { color: #ff8a8a; }

        @media (max-width: 768px) { header h1 { font-size: 2.8em; padding-right: 40px; } .splash-text { font-size: 0.35em; right: -2px; bottom: 6px; } .game-grid { grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; } #chat-btn, #theme-switcher-btn, #language-switcher-btn, #login-btn { padding: 6px 12px; font-size: 0.85em; } #top-actions-container { top: 15px; right: 15px; gap: 8px;} }
        @media (max-width: 480px) { body { padding: 10px; } header h1 { font-size: 2.2em; padding-right: 35px; } .splash-text { font-size: 0.3em; padding: 1px 5px; right: 2px; bottom: 3px; } header p { font-size: 1em; } .game-grid { grid-template-columns: 1fr; gap: 20px; max-width: 300px; } .game-card .content { padding: 10px; } .game-card h2 { font-size: 1.1em; } .game-card p { font-size: 0.8em; } #chat-btn, #theme-switcher-btn, #language-switcher-btn, #login-btn { padding: 5px 10px; font-size: 0.8em; } #top-actions-container { top: 10px; right: 10px; gap: 6px;} }
    </style>
</head>
<body>
    <div id="top-actions-container">
        <button id="chat-btn">üí¨</button>
        <button id="theme-switcher-btn">üåô</button>
        <button id="language-switcher-btn">
            <span class="lang-current">CS</span><span class="lang-separator">‚áå</span><span class="lang-target">EN</span>
        </button>
        <a href="#" id="login-btn" data-translate-key="loginButtonText">Login</a>
    </div>

    <header>
        <h1>90Tom<span class="splash-text">fun!</span></h1>
        <p data-translate-key="welcomeMessage">V√≠t√°m V√°s! Vyberte si nƒõjakou hru n√≠≈æe a u≈æijte si!</p>
    </header>

    <main class="game-grid">
        <!-- Game Cards remain the same -->
        <div class="game-card">
            <a href="MILAN/MILAN.html" class="game-link">
                <img src="MILAN/milanbg.png" alt="Milanovy klob√°sy Game Preview">
                <div class="content">
                    <h2 data-translate-key="milanTitle">Milanovy klob√°sy</h2>
                    <p data-translate-key="milanDesc">P≈ôipravujte v√Ωteƒçn√° j√≠dla v oƒç√≠ch pr√©miov√©ho kucha≈ôe Milana.</p>
                </div>
            </a>
            <button class="leaderboard-btn" data-game="milan" title="Leaderboard">üèÜ</button>
        </div>
        <div class="game-card">
            <a href="bloonstdaitst.html" class="game-link">
                <img src="IndexImages/blonkytm.png" alt="Bl√≥nkyTM Game Preview">
                <div class="content">
                    <h2 data-translate-key="blonkyTitle">Bl√≥nky TM</h2>
                    <p data-translate-key="blonkyDesc">P≈ôedƒõl√°n√≠ zn√°m√© hry Bloons TD.</p>
                </div>
            </a>
        </div>
        <div class="game-card">
            <a href="KrumpTezic/KrumpTezic.html" class="game-link">
                <img src="IndexImages/krumptezic.png" alt="KrumpTezic Game Preview">
                <div class="content">
                    <h2 data-translate-key="krumptezicTitle">KrumpTezic</h2>
                    <p data-translate-key="krumptezicDesc">Z√°bavn√© tƒõ≈æen√≠ blok≈Ø z Minecraftu inspirov√°no hrou PickCrafter.</p>
                </div>
            </a>
            <button class="leaderboard-btn" data-game="krumptezic" title="Leaderboard">üèÜ</button>
        </div>
        <div class="game-card">
            <a href="PTAK 2/PTAK 2.html" class="game-link">
                <img src="IndexImages/ptak2.png" alt="PTAK 2 Game Preview">
                <div class="content">
                    <h2 data-translate-key="ptak2Title">PTAK 2</h2>
                    <p data-translate-key="ptak2DescLine1">Druh√© vyd√°n√≠ z s√°gy PTAK pro p. Ko≈ô√≠nka,</p>
                    <p data-translate-key="ptak2DescLine2">dobrodru≈æstv√≠ pt√°ka, koƒçky a psa.</p>
                </div>
            </a>
            <button class="leaderboard-btn" data-game="ptak2" title="Leaderboard">üèÜ</button>
        </div>
    </main>
    
    <!-- Modals -->
    <div id="login-modal" class="modal">
        <!-- Login/Register content remains the same -->
    </div>

    <div id="leaderboard-modal" class="modal">
        <!-- Leaderboard content remains the same -->
    </div>

    <!-- NEW PROFILE MODAL -->
    <div id="profile-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <div class="profile-header">
                <div id="profile-pic-container">
                    <img id="profile-pic" src="default-pfp.png" alt="Profile Picture">
                    <label for="upload-pic-input" id="upload-pic-label">
                        <img id="upload-pic-icon" src="camera-icon.png" alt="Upload">
                    </label>
                    <input type="file" id="upload-pic-input" accept="image/*">
                </div>
                <div class="profile-info">
                    <h1 id="profile-name">Player Name</h1>
                    <p id="profile-level">Level 1</p>
                    <div class="xp-bar-container">
                        <div id="xp-bar-fill"></div>
                    </div>
                    <p id="xp-text">0 / 100 XP</p>
                </div>
            </div>
            <div class="achievements-section">
                <h2>√öspƒõchy</h2>
                <div id="achievements-grid">
                    <!-- Achievements will be loaded here -->
                </div>
            </div>
        </div>
    </div>


    <footer>
        <p data-translate-key="footerText">Vytvo≈ôil s ‚ù§Ô∏è 90Tom</p>
    </footer>

    <!-- JS -->
    <script type="text/javascript">
        // --- Translations object remains the same ---
        const translations = {
            cs: {
                welcomeMessage: "V√≠t√°m V√°s! Vyberte si nƒõjakou hru n√≠≈æe a u≈æijte si!",
                blonkyTitle: "Bl√≥nky TM",
                blonkyDesc: "P≈ôedƒõl√°n√≠ zn√°m√© hry Bloons TD.",
                krumptezicTitle: "KrumpTezic",
                krumptezicDesc: "Z√°bavn√© tƒõ≈æen√≠ blok≈Ø z Minecraftu inspirov√°no hrou PickCrafter.",
                ptak2Title: "PTAK 2",
                ptak2DescLine1: "Druh√© vyd√°n√≠ z s√°gy PTAK pro p. Ko≈ô√≠nka,",
                ptak2DescLine2: "dobrodru≈æstv√≠ pt√°ka, koƒçky a psa.",
                milanTitle: "Milanovy klob√°sy",
                milanDesc: "P≈ôipravujte v√Ωteƒçn√° j√≠dla v oƒç√≠ch pr√©miov√©ho kucha≈ôe Milana.",
                footerText: "Vytvo≈ôil s ‚ù§Ô∏è 90Tom",
                loginButtonText: "P≈ôihl√°sit se",
                logoutButtonText: "Odhl√°sit se",
                modalLoginTitle: "P≈ôihl√°sit se",
                modalRegisterTitle: "Registrace",
                modalUsernameLabel: "U≈æivatelsk√© jm√©no (Email)",
                modalPasswordLabel: "Heslo",
                modalConfirmPasswordLabel: "Potvrƒète heslo",
                modalLoginButton: "P≈ôihl√°sit se",
                modalRegisterButton: "Zaregistrovat",
                modalNoAccount: "Nem√°te √∫ƒçet?",
                modalRegisterLink: "Zaregistrujte se",
                modalHaveAccount: "M√°te ji≈æ √∫ƒçet?",
                modalLoginLink: "P≈ôihlaste se",
            },
            en: {
                welcomeMessage: "Welcome! Choose a game below and enjoy!",
                blonkyTitle: "Bl√≥nky TM",
                blonkyDesc: "A remake of the well-known game Bloons TD.",
                krumptezicTitle: "KrumpTezic",
                krumptezicDesc: "Fun mining of Minecraft blocks inspired by the game PickCrafter.",
                ptak2Title: "PTAK 2",
                ptak2DescLine1: "Second edition of the PTAK saga for Mr. Ko≈ô√≠nek,",
                ptak2DescLine2: "Adventures of a bird, a cat, and a dog.",
                milanTitle: "Milan's Sausages",
                milanDesc: "Prepare delicious meals in the eyes of the premium chef Milan.",
                footerText: "Made with ‚ù§Ô∏è by 90Tom",
                loginButtonText: "Login",
                logoutButtonText: "Logout",
                modalLoginTitle: "Login",
                modalRegisterTitle: "Register",
                modalUsernameLabel: "Username (Email)",
                modalPasswordLabel: "Password",
                modalConfirmPasswordLabel: "Confirm Password",
                modalLoginButton: "Login",
                modalRegisterButton: "Register",
                modalNoAccount: "Don't have an account?",
                modalRegisterLink: "Register here",
                modalHaveAccount: "Already have an account?",
                modalLoginLink: "Login here",
            }
        };

        // --- Functions for language, theme, leaderboards remain the same ---

        // --- NEW SCRIPT LOGIC BELOW ---
        
        let currentLang = localStorage.getItem('selectedLanguage') || 'cs';
        let currentTheme = localStorage.getItem('selectedTheme') || 'light';

        // --- Functions for language, theme, leaderboards (NO CHANGES) ---
        function setLanguage(lang) {
            document.documentElement.lang = lang;
            localStorage.setItem('selectedLanguage', lang);
            currentLang = lang;
            document.querySelectorAll('[data-translate-key]').forEach(element => {
                const key = element.getAttribute('data-translate-key');
                if (translations[lang] && translations[lang][key]) {
                    element.textContent = translations[lang][key];
                }
            });
            const langSwitcherBtn = document.getElementById('language-switcher-btn');
            if (langSwitcherBtn) {
                const currentLangSpan = langSwitcherBtn.querySelector('.lang-current');
                const targetLangSpan = langSwitcherBtn.querySelector('.lang-target');
                if (lang === 'en') {
                    currentLangSpan.textContent = 'EN';
                    targetLangSpan.textContent = 'CS';
                } else {
                    currentLangSpan.textContent = 'CS';
                    targetLangSpan.textContent = 'EN';
                }
            }
            const currentUser = auth.currentUser;
            if (currentUser) {
                const loginBtn = document.getElementById('login-btn');
                const logoutText = translations[lang].logoutButtonText;
                loginBtn.textContent = `${logoutText} (${currentUser.displayName || currentUser.email})`;
            }
        }
        
        function setTheme(theme) {
            localStorage.setItem('selectedTheme', theme);
            currentTheme = theme;
            const themeSwitcherBtn = document.getElementById('theme-switcher-btn');
            if (theme === 'dark') {
                document.body.classList.add('dark-mode');
                if (themeSwitcherBtn) themeSwitcherBtn.textContent = '‚òÄÔ∏è';
            } else {
                document.body.classList.remove('dark-mode');
                if (themeSwitcherBtn) themeSwitcherBtn.textContent = 'üåô';
            }
        }

        async function deleteLeaderboardEntry(gameId, userToDelete) {
            if (typeof db === 'undefined') { alert("Spojen√≠ s datab√°z√≠ selhalo."); return; }
            const gameData = {
                milan: { key: "milan_leaderboard" },
                krumptezic: { key: "krumptezic_leaderboard" },
                ptak2: { key: "ptak2_leaderboard" },
            };
            const collectionName = gameData[gameId].key;
            try {
                const userDocRef = db.collection(collectionName).doc(userToDelete);
                await userDocRef.delete();
                showLeaderboard(gameId); 
            } catch (error) {
                console.error("Error deleting document: ", error);
            }
        }
        
        async function showLeaderboard(gameId) {
            // This function is unchanged
        }

        // --- NEW PROFILE AND ACHIEVEMENT LOGIC ---

        const achievements = {
            'account_created': { name: 'Vytvo≈ôen √öƒçet', icon: 'achievement-icon.png' }
            // Add more achievements here later
        };

        function calculateLevel(xp) {
            const level = Math.floor(Math.sqrt(xp / 100)) + 1;
            return level;
        }

        function xpForLevel(level) {
            return (level - 1) ** 2 * 100;
        }

        async function showProfile(user) {
            const profileModal = document.getElementById('profile-modal');
            if (!user || !profileModal) return;

            const userDocRef = db.collection('users').doc(user.uid);
            const userDoc = await userDocRef.get();
            const userData = userDoc.exists ? userDoc.data() : {};

            document.getElementById('profile-pic').src = userData.photoURL || 'default-pfp.png';
            document.getElementById('profile-name').textContent = user.displayName;

            const xp = userData.xp || 0;
            const level = calculateLevel(xp);
            const nextLevelXp = xpForLevel(level + 1);
            const currentLevelXp = xpForLevel(level);

            document.getElementById('profile-level').textContent = `Level ${level}`;
            document.getElementById('xp-text').textContent = `${xp - currentLevelXp} / ${nextLevelXp - currentLevelXp} XP`;
            const xpPercentage = ((xp - currentLevelXp) / (nextLevelXp - currentLevelXp)) * 100;
            document.getElementById('xp-bar-fill').style.width = `${xpPercentage}%`;

            // Display Achievements
            const achievementsGrid = document.getElementById('achievements-grid');
            achievementsGrid.innerHTML = ''; // Clear old achievements
            if (userData.achievements) {
                for (const achievementId of userData.achievements) {
                    const achievement = achievements[achievementId];
                    if (achievement) {
                        const achievementEl = document.createElement('div');
                        achievementEl.classList.add('achievement');
                        achievementEl.innerHTML = `
                            <img src="${achievement.icon}" alt="${achievement.name}">
                            <p>${achievement.name}</p>
                        `;
                        achievementsGrid.appendChild(achievementEl);
                    }
                }
            }

            profileModal.style.display = 'flex';
        }

        async function grantAchievement(userId, achievementId) {
            if (!userId || !achievementId) return;
            const userDocRef = db.collection('users').doc(userId);
            await userDocRef.update({
                achievements: firebase.firestore.FieldValue.arrayUnion(achievementId)
            });
        }

        async function addXp(userId, amount) {
            if (!userId || !amount) return;
            const userDocRef = db.collection('users').doc(userId);
            await userDocRef.update({
                xp: firebase.firestore.FieldValue.increment(amount)
            });
        }

        // --- DOMContentLoaded ---
        document.addEventListener('DOMContentLoaded', () => {
            const loginBtn = document.getElementById('login-btn');
            
            // Apply Saved Theme and Language
            setTheme(currentTheme);
            setLanguage(currentLang);

            // Card animation
            const cards = document.querySelectorAll('.game-card');
            cards.forEach((card, index) => {
                card.style.transition = `opacity 0.5s ease ${index * 0.1}s, transform 0.5s ease ${index * 0.1}s, filter 0.3s ease`;
                setTimeout(() => {
                    card.style.opacity = '1';
                    card.style.transform = 'translateY(0)';
                }, 50);
            });
            
            // Event Listeners for new buttons
            const themeSwitcherBtn = document.getElementById('theme-switcher-btn');
            if(themeSwitcherBtn) {
                themeSwitcherBtn.addEventListener('click', () => {
                    const newTheme = document.body.classList.contains('dark-mode') ? 'light' : 'dark';
                    setTheme(newTheme);
                });
            }

            const langSwitcherBtn = document.getElementById('language-switcher-btn');
            if (langSwitcherBtn) {
                langSwitcherBtn.addEventListener('click', () => {
                    const newLang = (document.documentElement.lang === 'cs') ? 'en' : 'cs';
                    setLanguage(newLang);
                });
            }

            const chatBtn = document.getElementById('chat-btn');
            if (chatBtn) {
                chatBtn.addEventListener('click', () => {
                    alert("Chat coming soon!"); // Placeholder for chat functionality
                });
            }
            
            // Modal variables
            const loginModal = document.getElementById('login-modal');
            const leaderboardModal = document.getElementById('leaderboard-modal');
            const profileModal = document.getElementById('profile-modal');
            const allModals = document.querySelectorAll('.modal');
            
            const loginView = document.getElementById('login-view');
            const registerView = document.getElementById('register-view');
            const showRegisterLink = document.getElementById('show-register-link');
            const showLoginLink = document.getElementById('show-login-link');
            
            const loginForm = document.getElementById('login-form');
            const registerForm = document.getElementById('register-form');
            
            // Authentication State Change Handler
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    sessionStorage.setItem('loggedInUser', user.displayName || user.email);
                    const logoutText = translations[currentLang].logoutButtonText;
                    loginBtn.textContent = `${logoutText} (${user.displayName || user.email})`;
                    loginBtn.removeAttribute('data-translate-key');
                    loginBtn.onclick = (e) => {
                        e.preventDefault();
                        if (e.target.id === 'login-btn') {
                            showProfile(user);
                        } else {
                           auth.signOut();
                        }
                    };
                    
                    // --- User Profile Initialization ---
                    const userDocRef = db.collection('users').doc(user.uid);
                    const userDoc = await userDocRef.get();
                    if (!userDoc.exists) {
                        await userDocRef.set({
                            displayName: user.displayName,
                            email: user.email,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            xp: 0,
                            achievements: ['account_created']
                        });
                        addXp(user.uid, 10); // Grant 10 XP for creating account
                    } else {
                        // Grant login XP once per day
                        const lastLogin = userDoc.data().lastLogin?.toDate();
                        const now = new Date();
                        if (!lastLogin || now.getDate() !== lastLogin.getDate() || now.getMonth() !== lastLogin.getMonth() || now.getFullYear() !== lastLogin.getFullYear()) {
                            await userDocRef.update({ lastLogin: firebase.firestore.FieldValue.serverTimestamp() });
                            addXp(user.uid, 5); // 5 XP for daily login
                        }
                    }

                } else {
                    sessionStorage.removeItem('loggedInUser');
                    loginBtn.setAttribute('data-translate-key', 'loginButtonText');
                    loginBtn.textContent = translations[currentLang].loginButtonText;
                    loginBtn.onclick = (e) => {
                        e.preventDefault();
                        loginView.style.display = 'block';
                        registerView.style.display = 'none';
                        loginModal.style.display = 'flex';
                    };
                }
            });
            
            // --- Event Listeners for Forms and Links ---
            showRegisterLink.addEventListener('click', (e) => { e.preventDefault(); loginView.style.display = 'none'; registerView.style.display = 'block'; });
            showLoginLink.addEventListener('click', (e) => { e.preventDefault(); registerView.style.display = 'none'; loginView.style.display = 'block'; });
            
            // Leaderboard and Modal functionality
            document.querySelectorAll('.leaderboard-btn').forEach(button => button.addEventListener('click', (e) => { e.stopPropagation(); showLeaderboard(e.currentTarget.dataset.game); }));
            leaderboardModal.addEventListener('click', (e) => { if (e.target.classList.contains('delete-score-btn')) { const userToDelete = e.target.dataset.user; const gameId = e.target.dataset.game; if(confirm(`Opravdu chcete smazat v√Ωsledek hr√°ƒçe ${userToDelete}?`)){ deleteLeaderboardEntry(gameId, userToDelete); } } });
            allModals.forEach(modal => { const closeBtn = modal.querySelector('.close-btn'); if (closeBtn) { closeBtn.onclick = () => { modal.style.display = 'none'; }; } });
            window.onclick = (event) => { if (event.target.classList.contains('modal')) { event.target.style.display = "none"; } };
            
            // Login/Register Forms
            loginForm.addEventListener('submit', (event) => {
                event.preventDefault();
                const email = document.getElementById('login-username').value;
                const password = document.getElementById('login-password').value;
                auth.signInWithEmailAndPassword(email, password)
                    .then(() => window.location.reload())
                    .catch((error) => document.getElementById('login-error-message').textContent = error.message);
            });
            
            registerForm.addEventListener('submit', (event) => {
                event.preventDefault();
                const displayName = document.getElementById('register-displayname').value;
                const email = document.getElementById('register-email').value;
                const password = document.getElementById('register-password').value;
                const confirmPassword = document.getElementById('confirm-password').value;
                const errorMessage = document.getElementById('register-error-message');

                if (password !== confirmPassword) { errorMessage.textContent = 'Hesla se neshoduj√≠.'; return; }
                if (displayName.length < 3) { errorMessage.textContent = 'Zobrazovan√© jm√©no mus√≠ m√≠t alespo≈à 3 znaky.'; return; }

                auth.createUserWithEmailAndPassword(email, password)
                    .then((userCredential) => {
                        return userCredential.user.updateProfile({ displayName: displayName })
                            .then(() => window.location.reload());
                    })
                    .catch((error) => errorMessage.textContent = error.message);
            });

            // --- NEW: Profile Picture Upload Logic ---
            const uploadPicInput = document.getElementById('upload-pic-input');
            uploadPicInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                const user = auth.currentUser;
                if (!file || !user) return;

                const filePath = `profile_pictures/${user.uid}/${file.name}`;
                const fileRef = storage.ref(filePath);
                const task = fileRef.put(file);

                task.on('state_changed', 
                    (snapshot) => { /* Can add upload progress bar here */ }, 
                    (error) => { console.error("Upload failed", error); alert("Upload failed!"); }, 
                    () => {
                        task.snapshot.ref.getDownloadURL().then(async (downloadURL) => {
                            await user.updateProfile({ photoURL: downloadURL });
                            await db.collection('users').doc(user.uid).update({ photoURL: downloadURL });
                            document.getElementById('profile-pic').src = downloadURL;
                            alert("Profile picture updated!");
                        });
                    }
                );
            });
        });
    </script>
</body>
</html>