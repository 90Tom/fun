<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>90Tom fun!</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script>
      const firebaseConfig = {
        apiKey: "AIzaSyDNzjX6dmx2fGPhLW-ZIADhNigsfwMY3Ng",
        authDomain: "tom-fun.firebaseapp.com",
        projectId: "tom-fun",
        storageBucket: "tom-fun.appspot.com",
        messagingSenderId: "710857129785",
        appId: "1:710857129785:web:5f2cdebe736577ea0e72e8",
        measurementId: "G-6MHP8FHQ87"
      };

      let db, auth;
      try {
        firebase.initializeApp(firebaseConfig);
        db = firebase.firestore();
        auth = firebase.auth();
      } catch (e) {
        console.error("Firebase initialization failed:", e);
        alert("CRITICAL ERROR: Could not connect to the kingdom's database. The leaderboards will not work.");
      }
    </script>

    <style>
        :root {
            --body-bg-overlay: rgba(255, 255, 255, 0.7);
            --text-color: #333;
            --text-color-light: #666;
            --header-bg: rgba(255, 255, 255, 0.6);
            --card-bg: #ffffff;
            --card-h2-color: #0056b3;
            --footer-bg: rgba(255, 255, 255, 0.6);
            --modal-bg: #fefefe;
            --input-bg: #ffffff;
            --input-border: #ddd;
            --table-header-bg: #f2f2f2;
            --table-row-hover: #f9f9f9;
            --button-bg: rgba(250, 250, 250, 0.65);
            --button-border: rgba(0, 0, 0, 0.15);
            --button-hover-bg: rgba(255, 255, 255, 0.85);
            --button-hover-border: rgba(0, 0, 0, 0.25);
            --card-border: transparent;
        }

        body.dark-mode {
            --body-bg-overlay: rgba(18, 18, 18, 0.85);
            --text-color: #f0f0f0;
            --text-color-light: #a0a0a0;
            --header-bg: rgba(30, 30, 30, 0.75);
            --card-bg: #1e1e1e;
            --card-h2-color: #58a6ff;
            --footer-bg: rgba(30, 30, 30, 0.75);
            --modal-bg: #2c2c2c;
            --input-bg: #252525;
            --input-border: #444;
            --table-header-bg: #1f1f1f;
            --table-row-hover: #3a3a3a;
            --button-bg: rgba(45, 45, 45, 0.7);
            --button-border: rgba(255, 255, 255, 0.1);
            --button-hover-bg: rgba(60, 60, 60, 0.8);
            --button-hover-border: rgba(255, 255, 255, 0.2);
            --card-border: rgba(255, 255, 255, 0.1);
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Poppins', sans-serif; color: var(--text-color); line-height: 1.6; background-image: url('IndexImages/backgroundindex.png'); background-size: cover; background-position: center center; background-attachment: fixed; display: flex; flex-direction: column; min-height: 100vh; align-items: center; padding: 20px; position: relative; z-index: 1; transition: color 0.3s ease; }
        body::before { content: ''; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--body-bg-overlay); z-index: -1; transition: background-color 0.3s ease; }
        header { text-align: center; margin-bottom: 40px; margin-top: 20px; max-width: 800px; width: 100%; background-color: var(--header-bg); padding: 15px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05); position: relative; transition: background-color 0.3s ease; }
        header h1 { color: red; font-weight: 700; font-size: 3.5em; margin-bottom: 5px; position: relative; display: inline-block; padding-right: 60px; }
        .splash-text { position: absolute; bottom: 0px; right: 30px; font-size: 0.4em; font-weight: 600; color: #FFD700; padding: 2px 8px; border-radius: 4px; transform: rotate(-15deg); animation: splash-pulse 2s infinite alternate ease-in-out; white-space: nowrap; pointer-events: none; }
        @keyframes splash-pulse { from { transform: rotate(-22deg) scale(1.1); } to { transform: rotate(-16deg) scale(1.3); } }
        header p { color: var(--text-color); font-size: 1.1em; transition: color 0.3s ease; }
        .game-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 30px; max-width: 1000px; width: 100%; flex-grow: 1; justify-content: center; }
        .game-card { background-color: var(--card-bg); border-radius: 12px; color: var(--text-color); box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); transition: all 0.3s ease; display: flex; flex-direction: column; text-align: center; overflow: hidden; border: 1px solid var(--card-border); opacity: 0; transform: translateY(20px); aspect-ratio: 1 / 1; position: relative; }
        .game-card .game-link { display: flex; flex-direction: column; flex-grow: 1; text-decoration: none; color: inherit; height: 100%; }
        .game-card img { display: block; width: 100%; height: 65%; object-fit: cover; transition: transform 0.3s ease, filter 0.3s ease; }
        .game-card .content { padding: 15px; width: 100%; display: flex; flex-direction: column; justify-content: center; flex-grow: 1; overflow: hidden; }
        .game-card:hover { transform: translateY(-10px) scale(1.05); box-shadow: 0 12px 35px rgba(232, 62, 140, 0.25); border-color: #e83e8c; }
        .game-card:hover img { transform: scale(1.03); filter: brightness(1.05); }
        .game-card h2 { margin-bottom: 5px; color: var(--card-h2-color); font-size: 1.2em; font-weight: 600; }
        .game-card p { color: var(--text-color-light); font-size: 0.85em; line-height: 1.3; }
        .leaderboard-btn { position: absolute; top: 10px; right: 10px; background-color: rgba(240, 240, 240, 0.8); border: 1px solid rgba(221, 221, 221, 0.8); border-radius: 50%; width: 30px; height: 30px; cursor: pointer; font-size: 16px; line-height: 28px; text-align: center; transition: all 0.2s ease; z-index: 5; backdrop-filter: blur(2px); }
        .leaderboard-btn:hover { background-color: #e83e8c; color: white; transform: scale(1.1); }
        footer { text-align: center; margin-top: 50px; padding: 15px; color: var(--text-color-light); font-size: 0.9em; width: 100%; max-width: 800px; background-color: var(--footer-bg); border-radius: 8px; transition: all 0.3s ease; }
        footer p { color: red; }
        #top-actions-container { position: fixed; top: 15px; right: 20px; z-index: 1001; display: flex; gap: 10px; align-items: center; }
        #theme-switcher-btn, #language-switcher-btn, #login-btn, #profile-btn, #chat-toggle-btn { background-color: var(--button-bg); color: var(--text-color); border: 1px solid var(--button-border); padding: 7px 14px; border-radius: 6px; cursor: pointer; font-family: 'Poppins', sans-serif; font-weight: 500; font-size: 0.9em; transition: all 0.2s ease; outline: none; box-shadow: 0 1px 3px rgba(0,0,0,0.05); text-decoration: none; display: inline-flex; align-items: center; justify-content: center; }
        #login-btn, #profile-btn { color: red; font-weight: 600; }
        #theme-switcher-btn:hover, #language-switcher-btn:hover, #login-btn:hover, #profile-btn:hover, #chat-toggle-btn:hover { background-color: var(--button-hover-bg); border-color: var(--button-hover-border); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        #login-btn:hover, #profile-btn:hover { color: #c00; }
        #language-switcher-btn .lang-current { font-weight: 600; }
        #language-switcher-btn .lang-separator { margin: 0 5px; opacity: 0.6; }
        #language-switcher-btn .lang-target { opacity: 0.7; }
        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); align-items: center; justify-content: center; }
        .modal-content { position: relative; background-color: var(--modal-bg); color: var(--text-color); padding: 40px; border-radius: 12px; box-shadow: 0 8px 30px rgba(0, 0, 0, 0.2); width: 90%; max-width: 500px; text-align: center; transition: all 0.3s ease; }
        .modal-content h1 { color: red; margin-bottom: 25px; font-weight: 600; }
        .input-group { margin-bottom: 20px; text-align: left; }
        .input-group label { display: block; margin-bottom: 8px; font-weight: 500; color: #d90429; }
        .input-group input { width: 100%; padding: 12px 15px; border-radius: 6px; border: 1px solid var(--input-border); font-family: 'Poppins', sans-serif; font-size: 1em; transition: border-color 0.3s ease, background-color 0.3s, color 0.3s; background-color: var(--input-bg); color: var(--text-color); }
        .input-group input:focus { outline: none; border-color: red; }
        .action-button { width: 100%; padding: 12px; border: none; background-color: red; color: white; font-size: 1.1em; font-weight: 600; border-radius: 6px; cursor: pointer; transition: background-color 0.3s ease; }
        .action-button:hover { background-color: #c00; }
        .error-message { color: red; margin-top: 15px; height: 20px; font-weight: 500; font-size: 0.9em; }
        .close-btn { color: #aaa; position: absolute; top: 10px; right: 20px; font-size: 28px; font-weight: bold; cursor: pointer; transition: color 0.3s ease;}
        .close-btn:hover, .close-btn:focus { color: var(--text-color); text-decoration: none; }
        .form-switch-text { margin-top: 20px; font-size: 0.9em; color: #d90429; }
        .form-switch-text a { color: red; font-weight: 600; cursor: pointer; text-decoration: none; }
        .form-switch-text a:hover { text-decoration: underline; }
        #register-view { display: none; }
        #leaderboard-table { width: 100%; margin-top: 20px; border-collapse: collapse; }
        #leaderboard-table th, #leaderboard-table td { padding: 10px; border-bottom: 1px solid var(--input-border); text-align: left; }
        #leaderboard-table th { background-color: var(--table-header-bg); }
        #leaderboard-table tr:hover { background-color: var(--table-row-hover); }
        .delete-score-btn { background: #ff5c5c; color: white; border: none; border-radius: 50%; width: 25px; height: 25px; cursor: pointer; line-height: 25px; font-size: 14px; }
        .delete-score-btn:hover { background: #ff1c1c; }
        .pfp-display { display: flex; justify-content: center; align-items: center; width: 150px; height: 150px; border-radius: 50%; margin: 0 auto 20px auto; border: 4px solid var(--card-border); overflow: hidden; }
        .pfp-display img { width: 100%; height: 100%; object-fit: cover; }
        .initials { font-weight: bold; color: white; }
        .pfp-display .initials { font-size: 50px; }
        .chat-message .initials { font-size: 16px; }
        #profile-info p, #user-view-info p { margin-bottom: 10px; }
        .pfp-choices { margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--input-border); }
        .pfp-choices h3 { font-size: 1em; margin-bottom: 10px; color: var(--text-color-light); }
        .avatar-grid, .color-grid { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin-bottom: 15px; }
        .avatar-choice { width: 50px; height: 50px; border-radius: 50%; cursor: pointer; border: 3px solid transparent; transition: border-color 0.2s; object-fit: cover; }
        .avatar-choice.selected, .color-choice.selected { border-color: red; }
        .color-choice { width: 30px; height: 30px; border-radius: 50%; cursor: pointer; border: 3px solid transparent; transition: border-color 0.2s; }
        #chat-popup { position: fixed; top: 0; left: 0; width: 350px; height: 100%; background-color: var(--card-bg); z-index: 1999; box-shadow: 5px 0 15px rgba(0,0,0,0.1); transform: translateX(-100%); transition: transform 0.3s ease-in-out; display: flex; flex-direction: column; border-right: 1px solid var(--card-border); }
        #chat-popup.open { transform: translateX(0); }
        #chat-header { padding: 15px; border-bottom: 1px solid var(--input-border); display: flex; justify-content: space-between; align-items: center; }
        #chat-header h2 { font-size: 1.2em; }
        #chat-close-btn { font-size: 24px; cursor: pointer; background: none; border: none; color: var(--text-color); }
        #chat-messages { flex-grow: 1; overflow-y: auto; padding: 15px; }
        #chat-form { padding: 15px; border-top: 1px solid var(--input-border); display: flex; gap: 10px; }
        #chat-input { flex-grow: 1; padding: 10px; border-radius: 6px; border: 1px solid var(--input-border); background-color: var(--input-bg); color: var(--text-color); }
        #chat-send-btn { padding: 10px 15px; background-color: red; color: white; border: none; border-radius: 6px; cursor: pointer; }
        .chat-message { display: flex; align-items: center; margin-bottom: 15px; }
        .pfp-container { width: 40px; height: 40px; border-radius: 50%; margin-right: 10px; display: flex; justify-content: center; align-items: center; flex-shrink: 0; overflow: hidden; }
        .pfp-container img { width: 100%; height: 100%; object-fit: cover; }
        .chat-message .message-content { display: flex; flex-direction: column; flex-grow: 1; }
        .chat-message .message-author { font-weight: 600; color: var(--card-h2-color); cursor: pointer; }
        .chat-message .message-text { word-break: break-word; }
        .message-deleted { color: var(--text-color-light); font-style: italic; }
        .message-meta { display: flex; justify-content: space-between; align-items: center; }
        .delete-msg-btn { background: none; border: none; color: var(--text-color-light); cursor: pointer; font-size: 14px; margin-left: 10px; }
        .delete-msg-btn:hover { color: red; }
        .achievements-section { margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--input-border); }
        .achievements-section h3 { font-size: 1.2em; margin-bottom: 10px; }
        .achievement { display: flex; align-items: center; margin-bottom: 10px; text-align: left; }
        .achievement img { width: 50px; height: 50px; margin-right: 15px; }
        .achievement-info h4 { margin: 0; font-size: 1em; }
        .achievement-info p { margin: 0; font-size: 0.85em; color: var(--text-color-light); }

        body.dark-mode #login-btn, body.dark-mode #profile-btn { color: #ff4d4d; }
        body.dark-mode #login-btn:hover, body.dark-mode #profile-btn:hover { color: #ff8a8a; }

        @media (max-width: 768px) { header h1 { font-size: 2.8em; padding-right: 40px; } .splash-text { font-size: 0.35em; right: -2px; bottom: 6px; } .game-grid { grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; } #theme-switcher-btn, #language-switcher-btn, #login-btn, #profile-btn, #chat-toggle-btn { padding: 6px 12px; font-size: 0.85em; } #top-actions-container { top: 15px; right: 15px; gap: 8px;} #chat-popup { width: 300px; } }
        @media (max-width: 480px) { body { padding: 10px; } header h1 { font-size: 2.2em; padding-right: 35px; } .splash-text { font-size: 0.3em; padding: 1px 5px; right: 2px; bottom: 3px; } header p { font-size: 1em; } .game-grid { grid-template-columns: 1fr; gap: 20px; max-width: 300px; } .game-card .content { padding: 10px; } .game-card h2 { font-size: 1.1em; } .game-card p { font-size: 0.8em; } #theme-switcher-btn, #language-switcher-btn, #login-btn, #profile-btn, #chat-toggle-btn { padding: 5px 10px; font-size: 0.8em; } #top-actions-container { top: 10px; right: 10px; gap: 6px;} #chat-popup { width: 100%; } }
    </style>
</head>
<body>
    <div id="top-actions-container">
        <button id="profile-btn" style="display: none;">Profil</button>
        <button id="chat-toggle-btn" style="display: none;">💬</button>
        <button id="theme-switcher-btn">🌙</button>
        <button id="language-switcher-btn">
            <span class="lang-current">CS</span><span class="lang-separator">⇌</span><span class="lang-target">EN</span>
        </button>
        <a href="#" id="login-btn" data-translate-key="loginButtonText">Login</a>
    </div>

    <header>
        <h1>90Tom<span class="splash-text">fun!</span></h1>
        <p data-translate-key="welcomeMessage">Vítám Vás! Vyberte si nějakou hru níže a užijte si!</p>
    </header>

    <main class="game-grid">
        <div class="game-card">
            <a href="MILAN/MILAN.html" class="game-link">
                <img src="MILAN/milanbg.png" alt="Milanovy klobásy Game Preview">
                <div class="content">
                    <h2 data-translate-key="milanTitle">Milanovy klobásy</h2>
                    <p data-translate-key="milanDesc">Připravujte výtečná jídla v očích prémiového kuchaře Milana.</p>
                </div>
            </a>
            <button class="leaderboard-btn" data-game="milan" title="Leaderboard">🏆</button>
        </div>
        <div class="game-card">
            <a href="bloonstdaitst.html" class="game-link">
                <img src="IndexImages/blonkytm.png" alt="BlónkyTM Game Preview">
                <div class="content">
                    <h2 data-translate-key="blonkyTitle">Blónky TM</h2>
                    <p data-translate-key="blonkyDesc">Předělání známé hry Bloons TD.</p>
                </div>
            </a>
        </div>
        <div class="game-card">
            <a href="KrumpTezic/KrumpTezic.html" class="game-link">
                <img src="IndexImages/krumptezic.png" alt="KrumpTezic Game Preview">
                <div class="content">
                    <h2 data-translate-key="krumptezicTitle">KrumpTezic</h2>
                    <p data-translate-key="krumptezicDesc">Zábavné těžení bloků z Minecraftu inspirováno hrou PickCrafter.</p>
                </div>
            </a>
            <button class="leaderboard-btn" data-game="krumptezic" title="Leaderboard">🏆</button>
        </div>
        <div class="game-card">
            <a href="PTAK 2/PTAK 2.html" class="game-link">
                <img src="IndexImages/ptak2.png" alt="PTAK 2 Game Preview">
                <div class="content">
                    <h2 data-translate-key="ptak2Title">PTAK 2</h2>
                    <p data-translate-key="ptak2DescLine1">Druhé vydání z ságy PTAK pro p. Kořínka,</p>
                    <p data-translate-key="ptak2DescLine2">dobrodružství ptáka, kočky a psa.</p>
                </div>
            </a>
            <button class="leaderboard-btn" data-game="ptak2" title="Leaderboard">🏆</button>
        </div>
    </main>

    <div id="chat-popup">
        <div id="chat-header">
            <h2>Veřejný Chat</h2>
            <button id="chat-close-btn">&times;</button>
        </div>
        <div id="chat-messages"></div>
        <form id="chat-form">
            <input type="text" id="chat-input" placeholder="Napište zprávu..." autocomplete="off" required>
            <button type="submit" id="chat-send-btn">Odeslat</button>
        </form>
    </div>
    
    <div id="login-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <div id="login-view">
                <h1 data-translate-key="modalLoginTitle">Přihlásit se</h1>
                <form id="login-form">
                    <div class="input-group">
                        <label for="login-username" data-translate-key="modalUsernameLabel">Uživatelské jméno (Email)</label>
                        <input type="email" id="login-username" required>
                    </div>
                    <div class="input-group">
                        <label for="login-password" data-translate-key="modalPasswordLabel">Heslo</label>
                        <input type="password" id="login-password" required>
                    </div>
                    <button type="submit" class="action-button" data-translate-key="modalLoginButton">Přihlásit se</button>
                    <div id="login-error-message" class="error-message"></div>
                </form>
                <p class="form-switch-text">
                    <span data-translate-key="modalNoAccount">Nemáte účet?</span>
                    <a id="show-register-link" data-translate-key="modalRegisterLink">Zaregistrujte se</a>
                </p>
            </div>
            <div id="register-view">
                <h1 data-translate-key="modalRegisterTitle">Registrace</h1>
                <form id="register-form">
                     <div class="input-group">
                        <label for="register-displayname">Zobrazované jméno</label>
                        <input type="text" id="register-displayname" required>
                    </div>
                    <div class="input-group">
                        <label for="register-email" data-translate-key="modalUsernameLabel">Email</label>
                        <input type="email" id="register-email" required>
                    </div>
                    <div class="input-group">
                        <label for="register-password" data-translate-key="modalPasswordLabel">Heslo</label>
                        <input type="password" id="register-password" required>
                    </div>
                     <div class="input-group">
                        <label for="confirm-password" data-translate-key="modalConfirmPasswordLabel">Potvrďte heslo</label>
                        <input type="password" id="confirm-password" required>
                    </div>
                    <button type="submit" class="action-button" data-translate-key="modalRegisterButton">Zaregistrovat</button>
                    <div id="register-error-message" class="error-message"></div>
                </form>
                <p class="form-switch-text">
                    <span data-translate-key="modalHaveAccount">Máte již účet?</span>
                    <a id="show-login-link" data-translate-key="modalLoginLink">Přihlaste se</a>
                </p>
            </div>
        </div>
    </div>

    <div id="leaderboard-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h1 id="leaderboard-title">Leaderboard</h1>
            <table id="leaderboard-table">
                <thead id="leaderboard-head"></thead>
                <tbody id="leaderboard-body"></tbody>
            </table>
        </div>
    </div>

    <div id="profile-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h1>Profil</h1>
            <div class="pfp-display" id="profile-pfp-container"></div>
            <div id="profile-info"></div>
            <div class="pfp-choices">
                <h3>Vyberte si avatara</h3>
                <div class="avatar-grid" id="avatar-grid-choices"></div>
                <h3>Nebo si vyberte barvu</h3>
                <div class="color-grid" id="color-grid-choices"></div>
            </div>
            <button id="save-profile-btn" class="action-button" style="margin-top: 20px;">Uložit změny</button>
        </div>
    </div>

    <div id="user-view-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h1 id="user-view-title">Profil hráče</h1>
            <div class="pfp-display" id="user-view-pfp-container"></div>
            <div id="user-view-info"></div>
            <div class="achievements-section">
                <h3>Odznaky</h3>
                <div id="user-view-achievements"></div>
            </div>
        </div>
    </div>

    <footer>
        <p data-translate-key="footerText">Vytvořil s ❤️ 90Tom</p>
    </footer>

    <script type="text/javascript">
        const translations = {
            cs: {
                welcomeMessage: "Vítám Vás! Vyberte si nějakou hru níže a užijte si!",
                blonkyTitle: "Blónky TM",
                blonkyDesc: "Předělání známé hry Bloons TD.",
                krumptezicTitle: "KrumpTezic",
                krumptezicDesc: "Zábavné těžení bloků z Minecraftu inspirováno hrou PickCrafter.",
                ptak2Title: "PTAK 2",
                ptak2DescLine1: "Druhé vydání z ságy PTAK pro p. Kořínka,",
                ptak2DescLine2: "dobrodružství ptáka, kočky a psa.",
                milanTitle: "Milanovy klobásy",
                milanDesc: "Připravujte výtečná jídla v očích prémiového kuchaře Milana.",
                footerText: "Vytvořil s ❤️ 90Tom",
                loginButtonText: "Přihlásit se",
                logoutButtonText: "Odhlásit se",
                modalLoginTitle: "Přihlásit se",
                modalRegisterTitle: "Registrace",
                modalUsernameLabel: "Uživatelské jméno (Email)",
                modalPasswordLabel: "Heslo",
                modalConfirmPasswordLabel: "Potvrďte heslo",
                modalLoginButton: "Přihlásit se",
                modalRegisterButton: "Zaregistrovat",
                modalNoAccount: "Nemáte účet?",
                modalRegisterLink: "Zaregistrujte se",
                modalHaveAccount: "Máte již účet?",
                modalLoginLink: "Přihlaste se",
            },
            en: {
                welcomeMessage: "Welcome! Choose a game below and enjoy!",
                blonkyTitle: "Blónky TM",
                blonkyDesc: "A remake of the well-known game Bloons TD.",
                krumptezicTitle: "KrumpTezic",
                krumptezicDesc: "Fun mining of Minecraft blocks inspired by the game PickCrafter.",
                ptak2Title: "PTAK 2",
                ptak2DescLine1: "Second edition of the PTAK saga for Mr. Kořínek,",
                ptak2DescLine2: "Adventures of a bird, a cat, and a dog.",
                milanTitle: "Milan's Sausages",
                milanDesc: "Prepare delicious meals in the eyes of the premium chef Milan.",
                footerText: "Made with ❤️ by 90Tom",
                loginButtonText: "Login",
                logoutButtonText: "Logout",
                modalLoginTitle: "Login",
                modalRegisterTitle: "Register",
                modalUsernameLabel: "Username (Email)",
                modalPasswordLabel: "Password",
                modalConfirmPasswordLabel: "Confirm Password",
                modalLoginButton: "Login",
                modalRegisterButton: "Register",
                modalNoAccount: "Don't have an account?",
                modalRegisterLink: "Register here",
                modalHaveAccount: "Already have an account?",
                modalLoginLink: "Login here",
            }
        };

        let currentLang = localStorage.getItem('selectedLanguage') || 'cs';
        let currentTheme = localStorage.getItem('selectedTheme') || 'light';
        let currentUserData = null;

        const pfpColors = ["#f44336", "#9c27b0", "#3f51b5", "#009688", "#4caf50", "#ffeb3b", "#ff9800", "#795548", "#607d8b"];
        const presetAvatars = [
            'pfps/cat.png', 
            'pfps/dog.png'
        ];

        const ACHIEVEMENTS_LIST = {
            'milan_first_game': {
                name: 'Začínající kuchař',
                desc: 'Odehrál první hru Milanovy klobásy.',
                icon: 'https://i.ibb.co/6yV2Z8j/milan-ach.png'
            },
            'krump_first_game': {
                name: 'První krumpáč',
                desc: 'Odehrál první hru KrumpTezic.',
                icon: 'https://i.ibb.co/F83Wp2P/krump-ach.png'
            },
            'ptak_first_game': {
                name: 'Vzlétnutí',
                desc: 'Odehrál první hru PTAK 2.',
                icon: 'https://i.ibb.co/d2x9sVd/ptak-ach.png'
            }
        };

        let selectedAvatarUrl = null;
        let selectedColor = null;

        function getInitials(name) {
            if (!name) return '?';
            const parts = name.trim().split(' ');
            if (parts.length > 1 && parts[1]) {
                return parts[0][0].toUpperCase() + parts[parts.length - 1][0].toUpperCase();
            }
            return name.substring(0, 2).toUpperCase();
        }

        function getColorForName(name) {
            if (!name) return pfpColors[0];
            let hash = 0;
            for (let i = 0; i < name.length; i++) {
                hash = name.charCodeAt(i) + ((hash << 5) - hash);
            }
            const index = Math.abs(hash % pfpColors.length);
            return pfpColors[index];
        }
        
        function renderPfp(container, pfpData) {
            container.innerHTML = '';
            container.style.backgroundColor = 'transparent';
            if (pfpData.photoURL) {
                const img = document.createElement('img');
                img.src = pfpData.photoURL;
                container.appendChild(img);
            } else {
                container.style.backgroundColor = pfpData.pfpColor || getColorForName(pfpData.displayName);
                container.innerHTML = `<span class="initials">${getInitials(pfpData.displayName)}</span>`;
            }
        }

        function setLanguage(lang) {
            document.documentElement.lang = lang;
            localStorage.setItem('selectedLanguage', lang);
            currentLang = lang;

            document.querySelectorAll('[data-translate-key]').forEach(element => {
                const key = element.getAttribute('data-translate-key');
                if (translations[lang] && translations[lang][key]) {
                    element.textContent = translations[lang][key];
                }
            });

            const langSwitcherBtn = document.getElementById('language-switcher-btn');
            if (langSwitcherBtn) {
                const currentLangSpan = langSwitcherBtn.querySelector('.lang-current');
                const targetLangSpan = langSwitcherBtn.querySelector('.lang-target');
                if (lang === 'en') {
                    currentLangSpan.textContent = 'EN';
                    targetLangSpan.textContent = 'CS';
                } else {
                    currentLangSpan.textContent = 'CS';
                    targetLangSpan.textContent = 'EN';
                }
            }

            const currentUser = auth.currentUser;
            if (currentUser) {
                const loginBtn = document.getElementById('login-btn');
                const logoutText = translations[lang].logoutButtonText;
                loginBtn.textContent = `${logoutText} (${currentUser.displayName || currentUser.email})`;
            }
        }
        
        function setTheme(theme) {
            localStorage.setItem('selectedTheme', theme);
            currentTheme = theme;
            const themeSwitcherBtn = document.getElementById('theme-switcher-btn');
            if (theme === 'dark') {
                document.body.classList.add('dark-mode');
                if (themeSwitcherBtn) themeSwitcherBtn.textContent = '☀️';
            } else {
                document.body.classList.remove('dark-mode');
                if (themeSwitcherBtn) themeSwitcherBtn.textContent = '🌙';
            }
        }

        async function deleteLeaderboardEntry(gameId, userToDelete) {
            if (typeof db === 'undefined') { alert("Spojení s databází selhalo."); return; }
            const gameData = {
                milan: { key: "milan_leaderboard" },
                krumptezic: { key: "krumptezic_leaderboard" },
                ptak2: { key: "ptak2_leaderboard" },
            };
            const collectionName = gameData[gameId].key;

            try {
                const userDocRef = db.collection(collectionName).doc(userToDelete);
                await userDocRef.delete();
                showLeaderboard(gameId); 
            } catch (error) {
                console.error("Error deleting document: ", error);
            }
        }
        
       async function showLeaderboard(gameId) {
            if (typeof db === 'undefined') {
                alert("Nelze se připojit k žebříčku. Zkontrolujte připojení nebo zkuste to znovu později.");
                return;
            }
            
            const leaderboardModal = document.getElementById('leaderboard-modal');
            const titleEl = document.getElementById('leaderboard-title');
            const headEl = document.getElementById('leaderboard-head');
            const bodyEl = document.getElementById('leaderboard-body');
            const currentUser = auth.currentUser;
            const isAdmin = currentUser && currentUser.displayName === '90Tom';

            const gameData = {
                milan: { title: "Milanovy Klobásy", fields: ['Objednávky', 'Čas Přežití'], query: db.collection("milan_leaderboard").orderBy('orders', 'desc').orderBy('time', 'desc') },
                krumptezic: { title: "KrumpTezic", fields: ['Nejvyšší Počet Bloků', 'Čas Výhry'], query: db.collection("krumptezic_leaderboard").orderBy('blocks', 'desc') },
                ptak2: { title: "PTAK 2", fields: ['Úroveň', 'Čas'], query: db.collection("ptak2_leaderboard").orderBy('level', 'desc').orderBy('time', 'asc') },
            };

            const { title, fields, query } = gameData[gameId];
            titleEl.textContent = `Žebříček: ${title}`;
            
            bodyEl.innerHTML = '<tr><td colspan="5">Načítání...</td></tr>';
            leaderboardModal.style.display = 'flex';

            try {
                const querySnapshot = await query.limit(10).get();
                const scores = querySnapshot.docs.map(doc => doc.data());

                headEl.innerHTML = '';
                bodyEl.innerHTML = '';
                
                let headers = '<th>#</th><th>Hráč</th>';
                fields.forEach(field => headers += `<th>${field}</th>`);
                if (isAdmin) headers += '<th>Akce</th>';
                headEl.innerHTML = `<tr>${headers}</tr>`;

                if (scores.length === 0) {
                    const colspan = isAdmin ? fields.length + 3 : fields.length + 2;
                    bodyEl.innerHTML = `<tr><td colspan="${colspan}">Zatím žádné výsledky!</td></tr>`;
                } else {
                    scores.forEach((score, index) => {
                        let row = `<td>${index + 1}</td><td>${score.user}</td>`;
                        if (gameId === 'milan') {
                            row += `<td>${score.orders}</td><td>${score.time}s</td>`;
                        } else if (gameId === 'krumptezic') {
                            row += `<td>${Math.floor(score.blocks)}</td><td>${score.winTime ? score.winTime + 's' : '-'}</td>`;
                        } else if (gameId === 'ptak2') {
                             const timeInSeconds = (score.time / 1000).toFixed(2);
                            row += `<td>${score.level}</td><td>${timeInSeconds}s</td>`;
                        }
                        if (isAdmin) {
                            row += `<td><button class="delete-score-btn" data-game="${gameId}" data-user="${score.user}" title="Smazat">🗑️</button></td>`;
                        }
                        bodyEl.innerHTML += `<tr>${row}</tr>`;
                    });
                }
            } catch (error) {
                 console.error("Error fetching leaderboard:", error);
                 bodyEl.innerHTML = `<tr><td colspan="4">Chyba při načítání žebříčku. Zkontrolujte, zda jsou v databázi nastaveny správné indexy pro kolekci: ${gameData[gameId].key}.</td></tr>`;
            }
        }

        function displayChatMessage(msg) {
            const messagesContainer = document.getElementById('chat-messages');
            const messageElement = document.createElement('div');
            messageElement.className = 'chat-message';
            
            const pfpContainer = document.createElement('div');
            pfpContainer.className = 'pfp-container';
            pfpContainer.onclick = () => showUserProfile(msg.userId);
            renderPfp(pfpContainer, { ...msg });

            const deleteBtn = (currentUserData && currentUserData.displayName === '90Tom') ? 
                `<button class="delete-msg-btn" onclick="deleteChatMessage('${msg.id}')">🗑️</button>` : '';
            
            messageElement.innerHTML = `
                ${pfpContainer.outerHTML}
                <div class="message-content">
                    <div class="message-meta">
                        <span class="message-author" onclick="showUserProfile('${msg.userId}')">${msg.displayName || 'Anonym'}</span>
                        ${deleteBtn}
                    </div>
                    <span class="message-text ${msg.deleted ? 'message-deleted' : ''}">
                        ${msg.deleted ? '[tato zpráva byla smazána]' : msg.text}
                    </span>
                </div>
            `;
            messagesContainer.appendChild(messageElement);
        }

        async function deleteChatMessage(msgId) {
            if (currentUserData.displayName !== '90Tom') return;
            if (confirm('Opravdu smazat tuto zprávu?')) {
                await db.collection('chat').doc(msgId).update({
                    text: '',
                    deleted: true
                });
            }
        }
        
        async function showUserProfile(userId) {
            const modal = document.getElementById('user-view-modal');
            const pfpContainer = document.getElementById('user-view-pfp-container');
            const infoContainer = document.getElementById('user-view-info');
            const achievementsContainer = document.getElementById('user-view-achievements');

            infoContainer.innerHTML = 'Načítání...';
            achievementsContainer.innerHTML = '';
            modal.style.display = 'flex';

            const userDoc = await db.collection('users').doc(userId).get();
            if (!userDoc.exists) {
                infoContainer.innerHTML = 'Uživatel nenalezen.';
                return;
            }
            const userData = userDoc.data();
            
            renderPfp(pfpContainer, userData);
            infoContainer.innerHTML = `
                <p><strong>Jméno:</strong> ${userData.displayName}</p>
                <p><strong>XP:</strong> ${userData.xp}</p>
            `;
            
            const achievementsSnapshot = await db.collection('users').doc(userId).collection('achievements').get();
            if (achievementsSnapshot.empty) {
                achievementsContainer.innerHTML = '<p>Zatím žádné odznaky.</p>';
            } else {
                achievementsSnapshot.forEach(doc => {
                    const achievementId = doc.id;
                    const achievementData = ACHIEVEMENTS_LIST[achievementId];
                    if (achievementData) {
                        const div = document.createElement('div');
                        div.className = 'achievement';
                        div.innerHTML = `
                            <img src="${achievementData.icon}" alt="${achievementData.name}">
                            <div class="achievement-info">
                                <h4>${achievementData.name}</h4>
                                <p>${achievementData.desc}</p>
                            </div>
                        `;
                        achievementsContainer.appendChild(div);
                    }
                });
            }
        }

        async function showMyProfile() {
            if (!currentUserData) return;

            const profileModal = document.getElementById('profile-modal');
            const pfpContainer = document.getElementById('profile-pfp-container');
            const profileInfo = document.getElementById('profile-info');
            const avatarGrid = document.getElementById('avatar-grid-choices');
            const colorGrid = document.getElementById('color-grid-choices');

            renderPfp(pfpContainer, currentUserData);

            profileInfo.innerHTML = `
                <p><strong>Jméno:</strong> ${currentUserData.displayName}</p>
                <p><strong>Email:</strong> ${currentUserData.email}</p>
                <p><strong>XP:</strong> ${currentUserData.xp}</p>
            `;

            avatarGrid.innerHTML = '';
            presetAvatars.forEach(url => {
                const img = document.createElement('img');
                img.src = url;
                img.className = 'avatar-choice';
                if (url === currentUserData.photoURL) {
                    img.classList.add('selected');
                }
                img.onclick = () => {
                    document.querySelectorAll('.avatar-choice, .color-choice').forEach(el => el.classList.remove('selected'));
                    img.classList.add('selected');
                    selectedAvatarUrl = url;
                    selectedColor = null;
                    renderPfp(pfpContainer, { photoURL: url, displayName: currentUserData.displayName });
                };
                avatarGrid.appendChild(img);
            });

            colorGrid.innerHTML = '';
            pfpColors.forEach(color => {
                const div = document.createElement('div');
                div.className = 'color-choice';
                div.style.backgroundColor = color;
                if (!currentUserData.photoURL && color === currentUserData.pfpColor) {
                    div.classList.add('selected');
                }
                div.onclick = () => {
                    document.querySelectorAll('.avatar-choice, .color-choice').forEach(el => el.classList.remove('selected'));
                    div.classList.add('selected');
                    selectedColor = color;
                    selectedAvatarUrl = null;
                    renderPfp(pfpContainer, { pfpColor: color, displayName: currentUserData.displayName });
                };
                colorGrid.appendChild(div);
            });
            
            selectedAvatarUrl = currentUserData.photoURL;
            selectedColor = currentUserData.pfpColor;
            profileModal.style.display = 'flex';
        }

        async function saveProfileChanges() {
            const user = auth.currentUser;
            if (!user) return;
            
            const updates = {};
            if (selectedAvatarUrl) {
                updates.photoURL = selectedAvatarUrl;
                updates.pfpColor = firebase.firestore.FieldValue.delete();
            } else {
                updates.pfpColor = selectedColor;
                updates.photoURL = firebase.firestore.FieldValue.delete();
            }

            try {
                await db.collection('users').doc(user.uid).update(updates);
                
                const authPhotoURL = selectedAvatarUrl ? 'custom' : '';
                if (user.photoURL !== authPhotoURL) {
                    await user.updateProfile({ photoURL: authPhotoURL });
                }
                
                const userDoc = await db.collection('users').doc(user.uid).get();
                currentUserData = userDoc.data();

                document.getElementById('profile-modal').style.display = 'none';
                alert("Profil uložen!");
            } catch (error) {
                console.error("Chyba při ukládání profilu: ", error);
                alert("Nepodařilo se uložit profil.");
            }
        }

        async function fetchCurrentUserData(uid) {
            const userDoc = await db.collection('users').doc(uid).get();
            if (userDoc.exists) {
                currentUserData = userDoc.data();
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const loginBtn = document.getElementById('login-btn');
            const profileBtn = document.getElementById('profile-btn');
            const chatToggleBtn = document.getElementById('chat-toggle-btn');
            const chatPopup = document.getElementById('chat-popup');
            const chatCloseBtn = document.getElementById('chat-close-btn');
            
            setTheme(currentTheme);
            setLanguage(currentLang);

            const cards = document.querySelectorAll('.game-card');
            cards.forEach((card, index) => {
                card.style.transition = `opacity 0.5s ease ${index * 0.1}s, transform 0.5s ease ${index * 0.1}s, filter 0.3s ease`;
                setTimeout(() => {
                    card.style.opacity = '1';
                    card.style.transform = 'translateY(0)';
                }, 50);
            });
            
            const themeSwitcherBtn = document.getElementById('theme-switcher-btn');
            if(themeSwitcherBtn) {
                themeSwitcherBtn.addEventListener('click', () => {
                    const newTheme = document.body.classList.contains('dark-mode') ? 'light' : 'dark';
                    setTheme(newTheme);
                });
            }

            const langSwitcherBtn = document.getElementById('language-switcher-btn');
            if (langSwitcherBtn) {
                langSwitcherBtn.addEventListener('click', () => {
                    const newLang = (document.documentElement.lang === 'cs') ? 'en' : 'cs';
                    setLanguage(newLang);
                });
            }
            
            const allModals = document.querySelectorAll('.modal');
            
            const loginView = document.getElementById('login-view');
            const registerView = document.getElementById('register-view');
            const showRegisterLink = document.getElementById('show-register-link');
            const showLoginLink = document.getElementById('show-login-link');
            
            auth.onAuthStateChanged(async user => {
                if (user) {
                    await fetchCurrentUserData(user.uid);
                    sessionStorage.setItem('loggedInUser', user.displayName || user.email);
                    const logoutText = translations[currentLang].logoutButtonText;
                    loginBtn.textContent = `${logoutText} (${user.displayName || user.email})`;
                    loginBtn.removeAttribute('data-translate-key');
                    profileBtn.style.display = 'inline-flex';
                    chatToggleBtn.style.display = 'inline-flex';
                    loginBtn.onclick = (e) => {
                        e.preventDefault();
                        auth.signOut();
                    };
                } else {
                    currentUserData = null;
                    sessionStorage.removeItem('loggedInUser');
                    loginBtn.setAttribute('data-translate-key', 'loginButtonText');
                    loginBtn.textContent = translations[currentLang].loginButtonText;
                    profileBtn.style.display = 'none';
                    chatToggleBtn.style.display = 'none';
                    chatPopup.classList.remove('open');
                    loginBtn.onclick = (e) => {
                        e.preventDefault();
                        loginView.style.display = 'block';
                        registerView.style.display = 'none';
                        document.getElementById('login-modal').style.display = 'flex';
                    };
                }
            });

            profileBtn.addEventListener('click', showMyProfile);
            document.getElementById('save-profile-btn').addEventListener('click', saveProfileChanges);

            chatToggleBtn.addEventListener('click', () => chatPopup.classList.add('open'));
            chatCloseBtn.addEventListener('click', () => chatPopup.classList.remove('open'));

            showRegisterLink.addEventListener('click', (e) => {
                e.preventDefault();
                loginView.style.display = 'none';
                registerView.style.display = 'block';
            });

            showLoginLink.addEventListener('click', (e) => {
                e.preventDefault();
                registerView.style.display = 'none';
                loginView.style.display = 'block';
            });

            document.querySelectorAll('.leaderboard-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    e.stopPropagation(); 
                    const gameId = e.currentTarget.dataset.game;
                    showLeaderboard(gameId);
                });
            });
            
            document.getElementById('leaderboard-modal').addEventListener('click', function(e) {
                if (e.target.classList.contains('delete-score-btn')) {
                    const userToDelete = e.target.dataset.user;
                    const gameId = e.target.dataset.game;
                    if(confirm(`Opravdu chcete smazat výsledek hráče ${userToDelete}?`)){
                        deleteLeaderboardEntry(gameId, userToDelete);
                    }
                }
            });

            allModals.forEach(modal => {
                const closeBtn = modal.querySelector('.close-btn');
                if (closeBtn) {
                    closeBtn.onclick = () => {
                        modal.style.display = 'none';
                    };
                }
            });
            
            window.onclick = (event) => {
                if (event.target.classList.contains('modal')) {
                    event.target.style.display = "none";
                }
            };
            
            document.getElementById('login-form').addEventListener('submit', function(event) {
                event.preventDefault();
                const email = document.getElementById('login-username').value;
                const password = document.getElementById('login-password').value;
                const errorMessage = document.getElementById('login-error-message');
                
                auth.signInWithEmailAndPassword(email, password)
                    .then(() => {
                        window.location.reload();
                    })
                    .catch((error) => {
                        errorMessage.textContent = error.message;
                    });
            });
            
            document.getElementById('register-form').addEventListener('submit', function(event) {
                event.preventDefault();
                const displayName = document.getElementById('register-displayname').value;
                const email = document.getElementById('register-email').value;
                const password = document.getElementById('register-password').value;
                const confirmPassword = document.getElementById('confirm-password').value;
                const errorMessage = document.getElementById('register-error-message');

                if (password !== confirmPassword) {
                    errorMessage.textContent = 'Hesla se neshodují.';
                    return;
                }
                if (displayName.length < 3) {
                    errorMessage.textContent = 'Zobrazované jméno musí mít alespoň 3 znaky.';
                    return;
                }

                auth.createUserWithEmailAndPassword(email, password)
                    .then((userCredential) => {
                        const user = userCredential.user;
                        return user.updateProfile({
                            displayName: displayName,
                            photoURL: ''
                        }).then(() => {
                             db.collection('users').doc(user.uid).set({
                                displayName: displayName,
                                email: email,
                                xp: 0,
                                pfpColor: getColorForName(displayName),
                                createdAt: firebase.firestore.FieldValue.serverTimestamp()
                            }).then(() => {
                                window.location.reload();
                            });
                        });
                    })
                    .catch((error) => {
                        errorMessage.textContent = error.message;
                    });
            });

            document.getElementById('chat-form').addEventListener('submit', function(e) {
                e.preventDefault();
                const chatInput = document.getElementById('chat-input');
                const text = chatInput.value.trim();
                const user = auth.currentUser;

                if (text && user && currentUserData) {
                    const message = {
                        text: text,
                        userId: user.uid,
                        displayName: currentUserData.displayName,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        deleted: false
                    };

                    if (currentUserData.photoURL) {
                        message.photoURL = currentUserData.photoURL;
                    } else {
                        message.pfpColor = currentUserData.pfpColor;
                    }

                    db.collection('chat').add(message);
                    chatInput.value = '';
                }
            });

            db.collection('chat').orderBy('createdAt', 'asc').limitToLast(50).onSnapshot(snapshot => {
                const messagesContainer = document.getElementById('chat-messages');
                const shouldScroll = messagesContainer.scrollTop + messagesContainer.clientHeight >= messagesContainer.scrollHeight - 20;
                
                messagesContainer.innerHTML = '';
                snapshot.forEach(doc => {
                    displayChatMessage({ id: doc.id, ...doc.data() });
                });

                if(shouldScroll){
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                }
            });
        });
    </script>
</body>
</html>